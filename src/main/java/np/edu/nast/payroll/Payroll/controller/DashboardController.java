package np.edu.nast.payroll.Payroll.controller;

import np.edu.nast.payroll.Payroll.entity.Attendance;
import np.edu.nast.payroll.Payroll.repository.EmployeeRepository;
import np.edu.nast.payroll.Payroll.repository.EmployeeLeaveRepository;
import np.edu.nast.payroll.Payroll.repository.AttendanceRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/dashboard")
@CrossOrigin(origins = "http://localhost:5173")
public class DashboardController {

    @Autowired
    private EmployeeRepository employeeRepository;

    @Autowired
    private EmployeeLeaveRepository leaveRepository;

    @Autowired
    private AttendanceRepository attendanceRepository;

    /**
     * UPDATED: Now accepts date parameters to calculate dynamic stats
     * based on the day selected in the frontend.
     */
    @GetMapping("/admin/stats")
    public Map<String, Object> getDashboardStats(
            @RequestParam(required = false) Integer year,
            @RequestParam(required = false) Integer month,
            @RequestParam(required = false) Integer day) {

        Map<String, Object> stats = new HashMap<>();
        try {
            // 1. Determine the Target Date (Default to today)
            LocalDate now = LocalDate.now();
            LocalDate targetDate = (year != null && month != null && day != null)
                    ? LocalDate.of(year, month, day)
                    : now;

            // 2. Fetch data based on the selected date
            long totalEmployees = employeeRepository.count();
            long pendingLeaves = leaveRepository.countByStatus("PENDING");

            // Get attendance count for the specific selected date
            long presentOnDate = attendanceRepository.countByAttendanceDate(targetDate);

            // 3. Calculation for the specific day
            String attendancePercentage = "0%";
            if (totalEmployees > 0) {
                double percentage = ((double) presentOnDate / totalEmployees) * 100;
                attendancePercentage = Math.round(percentage) + "%";
            }

            stats.put("totalWorkforce", totalEmployees);
            stats.put("leaveRequests", pendingLeaves);
            stats.put("dailyAttendance", attendancePercentage);

        } catch (Exception e) {
            e.printStackTrace();
            stats.put("totalWorkforce", 0);
            stats.put("leaveRequests", 0);
            stats.put("dailyAttendance", "0%");
        }
        return stats;
    }

    /**
     * UPDATED: Accept Filters for Day, Month, Year, and Search for the table records.
     */
    @GetMapping("/recent-attendance")
    public List<Attendance> getRecentAttendance(
            @RequestParam(required = false) Integer year,
            @RequestParam(required = false) Integer month,
            @RequestParam(required = false) Integer day,
            @RequestParam(required = false) String search) {
        try {
            // Default to today if parameters are missing
            LocalDate now = LocalDate.now();
            int filterYear = (year != null) ? year : now.getYear();
            int filterMonth = (month != null) ? month : now.getMonthValue();
            int filterDay = (day != null) ? day : now.getDayOfMonth();
            String filterSearch = (search != null) ? search : "";

            // Uses the custom Query in AttendanceRepository
            List<Attendance> list = attendanceRepository.findFilteredAttendance(
                    filterYear, filterMonth, filterDay, filterSearch
            );

            return (list != null) ? list : new ArrayList<>();
        } catch (Exception e) {
            e.printStackTrace();
            return new ArrayList<>();
        }
    }
}